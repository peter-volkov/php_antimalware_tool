<?php

require_once("Archiver.inc.php");
require_once("FileInfo.inc.php");

class Healer {

    function __construct() {
        $time_string = date("Y_m_d_H_i", $_SERVER["REQUEST_TIME"]);
        $this->quarantine_filename = "quarantine." . $time_string . ".zip";
        $this->log = "";
        
        $this->web_root_dir = $_SERVER['DOCUMENT_ROOT'];

        if (file_exists($this->quarantine_filename)) {
            $this->log .= 'Archive already exists. Deleting ' . $this->quarantine_filename;
            unlink($this->quarantine_filename);
        }

        $this->archiver = null;
    }

    function getQuarantineFilename() {
        return $this->quarantine_filename;
    }

    function parseXmlRecipe($xml_recipe) {
        $dom;
        try {
            $dom = new DOMDocument("1.0", "utf-8");
	        $dom->formatOutput = true; 
            $dom->loadXML($xml_recipe);
        }
        catch(Exception $e) {
            die("An exception has occured: " . $e->getMessage() . "\n");
        }
        if (!$dom) {
            die("An exception has occured: ");
        }
        return $dom;
    }

    function quarantineFile($filename) {

        if (!is_file($filename)) {
            $this->log .= "quarantine file error: file " . $filename . " doesn't exist" . PHP_EOL;
            return false;
        }


        $fileinfo = new FileInfo($filename);
        $file_hash = $fileinfo->crc32b;

        $this->archiver->addFile($filename, $file_hash);
        $meta_filename = $file_hash . ".meta";

        $this->archiver->createFile($meta_filename, (string)$fileinfo);

        return true;
    }

    function deleteFile($filename) {
        if (!is_file($filename)) {
            $this->log .= "delete file error: file " . $filename . " doesn't exist" . PHP_EOL;
            return false;
        }

        return unlink($filename);
    }

    function executeXmlRecipe($xml_recipe) {
        global $project_root_dir;
        
        $recipe = $this->parseXmlRecipe($xml_recipe);

        $quarantine_files = $recipe->getElementsByTagName("quarantine");
        $delete_files = $recipe->getElementsByTagName("delete");

        $this->archiver = new Archiver($this->quarantine_filename, "a");

        foreach ($quarantine_files as $quarantine_file_node) {
            $filename = $quarantine_file_node->nodeValue;
            $absolute_path = $this->web_root_dir . substr($filename, 1); 
            if ($this->quarantineFile($absolute_path)) {
                $this->log .= "file  " . $absolute_path . " was quarantined" . PHP_EOL;
            }
        }

        $this->archiver->close();

        foreach ($delete_files as $delete_file_node) {
            $filename = $delete_file_node->nodeValue;            
            $absolute_path = $this->web_root_dir . substr($filename, 1); 
            if ($this->deleteFile($absolute_path)) {             
                $this->log .= "file " . $absolute_path . " was deleted" . PHP_EOL;
            }
                    
        } 
        
        return $this->log;
    }
}
