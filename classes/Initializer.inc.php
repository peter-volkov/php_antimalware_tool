<?php

require_once("Util.inc.php");

class Initializer
{
     function __construct() {         
         $this->basedir = dirname(dirname(__FILE__));
         $this->config_path = $this->basedir . '/config.php';         
     }


     function template_output($message) {
         $util = new Util();
         $view = new View();
         $view->setTemplateDirAbsolutePath($util->web_root_dir . "/pat/static/templates/");
         $view->set("message", $message);
         $view->display("auth.tpl");
     }

	 function checkPasswordStrength($password) {

		if (strlen($password) < 8) {
			return "Error: Password is too short.";
		}

		$has_digit = preg_match("/\d+/", $password) ? 1 : 0;
		$has_uppercase = preg_match("/[A-Z]+/", $password) ? 1 : 0;
		$has_lowercase = preg_match("/[a-z]+/", $password) ? 1 : 0;
		$has_special = preg_match("/\W+/", $password) ? 1 : 0;

		$password_strength = $has_digit + $has_uppercase + $has_lowercase + $has_special;

		if ($password_strength < 3) {
			return "Error: Password doesn't contain at least three groups of symbols: uppercase, lowercase, digits, special.";
		}
		
		return "Ok";
   		
	}

	function setExecutorPassword($password) {
        $password = base64_encode($password);
		$contents = '<?php $executor_password = "' . $password  . '";';

		setcookie("executor_password", $password);

		file_put_contents($this->config_path , $contents);
	}

    function isInitialized() {        
        return is_file($this->config_path);
    }
    
    function showPasswordCreationView() {
        $this->template_output("Придумайте пароль для доступа.");
    }

	function initialize() {
        if (!empty($_POST['executor_password'])) {
            $executor_password = $_POST['executor_password'];
            $password_strength = $this->checkPasswordStrength($executor_password);
    	    if ( $password_strength == "Ok" )
            {     
                $this->setExecutorPassword($executor_password);
                //to be fixed later
                header("Location: scanner.php");

                return true;
            } else {
                return $password_strength;                
            }
    
        } else {
            $this->showPasswordCreationView();
            return false;
        }

	}

}