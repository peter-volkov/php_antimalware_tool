<?php

class Initializer
{
     public function __construct() {
         $this->basedir = dirname(dirname(__FILE__));
         $this->config_path = $this->basedir . '/config.php';
         if (!$this->isInitialized()) {
             $this->initialize();
         }
     }

	 private function checkPasswordStrength($password) {

		if (strlen($password) < 8) {
			return "Error: Password is too short.";
		}

		$has_digit = preg_match("/\d+/", $password) ? 1 : 0;
		$has_uppercase = preg_match("/[A-Z]+/", $password) ? 1 : 0;
		$has_lowercase = preg_match("/[a-z]+/", $password) ? 1 : 0;
		$has_special = preg_match("/\W+/", $password) ? 1 : 0;

		$password_strength = $has_digit + $has_uppercase + $has_lowercase + $has_special;

		if ($password_strength < 3) {
			return "Error: Password doesn't contain at least three groups of symbols: uppercase, lowercase, digits, special.";
		}
		
		return "Ok";
   		
	}

	private function setExecutorPassword($password) {
		$contents = '<?php $executor_password = "' . base64_encode($password) . '";';
		file_put_contents($this->config_path , $contents);
	}

    private function isInitialized() {
        return is_file($this->config_path);
    }

	private function initialize() {
        if (!empty($_POST['executor_password'])) {
            $executor_password = $_POST['executor_password'];
            $password_strength = $this->checkPasswordStrength($executor_password);
    	    if ( $password_strength == "Ok" )
            {     
                $this->setExecutorPassword($executor_password);
            } else {
                die($password_strength);
            }
    
        } else {
            echo '<form action="'.$_SERVER['PHP_SELF'].'" method="POST"><input name="executor_password" type="password"></input><input type="submit"></form>';
            die();
        }

	}

}