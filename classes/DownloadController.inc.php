<?php

ob_start();
require_once("Archiver.inc.php");
require_once("Auth.inc.php");
ob_end_clean();


class DownloadController {

    function getPackedArchive() {
        global $project_root_dir; 
        $log_filename = 'scan_log.xml';
    	$log_filepath = $project_root_dir . '/' . $log_filename;
     	$packed_log_filename = $log_filename . '.zip';

        if (!is_file($log_filename)) {
            die('There is no xml log. You have to run scan again.');
        }

        $xml_data = file_get_contents($log_filename);

        $archiver = new Archiver($packed_log_filename, 'w');
        $archiver->createFile($log_filename, $xml_data);
        $archiver->close();

        header("Pragma: public");
        header("Expires: 0");
        header("Cache-Control: must-revalidate, post-check=0, pre-check=0");
        header("Cache-Control: private",false);
        header("Content-Type: application/zip");
        header("Content-Disposition: attachment; filename=".basename($packed_log_filename).";" );
        header("Content-Transfer-Encoding: binary");
        header("Content-Length: ".filesize($packed_log_filename));
        readfile($packed_log_filename);               

        unlink($packed_log_filename);
        unlink($log_filename);
        $this->removeTempFiles();
    }

    function start() {
        $this->getPackedArchive();
    }


}