<?php

class FileSystemSnapshot
{
    private $files = array();

    public function getFileInfoArray() {
        return $this->files; 
    }

	function takeSnapshot($base_dir_name=NULL)
	{	    
        if (!$base_dir_name)
            $base_dir_name = $_SERVER['DOCUMENT_ROOT'] . '/';
       
        $current_directory = end(explode('/', getcwd()));
		$excluded_dirs = array(".", "..", $current_directory);

		if (is_dir($base_dir_name)) 
		{
			if ($base_dir = opendir($base_dir_name)) 
			{
				while (($basedir_element_name = readdir($base_dir)) !== false) 
				{

				    $absolute_path = $base_dir_name . $basedir_element_name;
 
					if (is_file($absolute_path)) 
					{        
                        $fileinfo = new FileInfo($absolute_path);
                        array_push($this->files, $fileinfo);

					} else if (is_dir($absolute_path) && !in_array($basedir_element_name, $excluded_dirs)) {
                        $this->takeSnapshot($absolute_path . "/");
					}

				}
				closedir($base_dir);

			} else print " dir opening error";

		} else print " no such dir";

	}


	public function getXMLNode()
	{   
        $dom = new DOMDocument("1.0", "utf-8");

		$files_node = $dom->createElement("files");

        foreach($this->files as $fileinfo) {
    		$fileinfo_node = $dom->createElement("file");
    		$fileinfo_node->appendChild($dom->createElement("path",$fileinfo->name));
	    	$fileinfo_node->appendChild($dom->createElement("crc32",$fileinfo->crc32));
		    $fileinfo_node->appendChild($dom->createElement("md5",$fileinfo->md5));
    		$fileinfo_node->appendChild($dom->createElement("size",$fileinfo->size));
	    	$fileinfo_node->appendChild($dom->createElement("time_modified",$fileinfo->lastmodified));
			$files_node->appendChild($fileinfo_node);
        }
		
		$dom->appendChild($files_node);

        return $dom->getElementsByTagName("files")->item(0);

	}

        
}

?>