<?php

ob_start();
require_once("FileInfo.inc.php");
require_once("Healer.inc.php");
require_once("View.inc.php");
require_once("XmlValidator.inc.php");
require_once("Auth.inc.php");
ob_end_clean();

class ExecutorController {

	function startExecutor() {
		if (!empty($_POST) && !empty($_POST["recipe"])) 
		{
			$healer = new Healer();
			$xml_recipe = $_POST["recipe"];
		   
			$validator = new XmlValidator();
            global $project_root_dir;
			if (!$validator->validate($xml_recipe, $project_root_dir . "/static/xsd/recipe.xsd")) {
				die('xml is broken');
			}

			$view = new View();
			$view->set("title", "Result");
			$view->set("result", $healer->executeXmlRecipe($xml_recipe));
			$view->set("quarantine_url", $healer->getQuarantineFilename());
			$view->display("executor_result.tpl");

		} else {

			$view = new View();
			$view->display("executor_recipe_form.tpl");
		}

	}

	function templateOutput($message) {
		   $view = new View();
		   $view->set("message", $message);
		   $view->display("auth.tpl");
	}

	function start() {
		$authenticator = new Auth();

		if ($authenticator->auth()) {
			$this->startExecutor();
		}
	}

}                       