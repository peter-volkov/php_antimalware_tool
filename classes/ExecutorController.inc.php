<?php

ob_start();
require_once("FileInfo.inc.php");
require_once("Healer.inc.php");
require_once("View.inc.php");
require_once("XmlValidator.inc.php");
require_once("Initializer.inc.php");
require_once("Util.inc.php");
ob_end_clean();

class ExecutorController {

	function startExecutor() {
		if (!empty($_POST) && !empty($_POST["recipe"])) 
		{
			$healer = new Healer();
			$xml_recipe = $_POST["recipe"];
		   
			$validator = new XmlValidator();
			if (!$validator->validate($xml_recipe, "static/xsd/recipe.xsd")) {
				die('xml is broken');
			}
			$util = new Util();
			$view = new View();
            $view->setTemplateDirAbsolutePath($util->web_root_dir . "/pat/static/templates/");
			$view->set("title", "Result");
			$view->set("result", $healer->executeXmlRecipe($xml_recipe));
			$view->set("quarantine_url", $healer->getQuarantineFilename());
			$view->display("executor_result.tpl");

		} else {

		    $util = new Util();
			$view = new View();
            $view->setTemplateDirAbsolutePath($util->web_root_dir . "/pat/static/templates/");
			$view->display("executor_recipe_form.tpl");
		}

	}

	function templateOutput($message) {
		   $util = new Util();
		   $view = new View();
		   $view->setTemplateDirAbsolutePath($util->web_root_dir . "/pat/static/templates/");
		   $view->set("message", $message);
		   $view->display("auth.tpl");
	}

	function start() {

		$initializer = new Initializer();

		//First run
		//Console run check for unittests
		if (!$initializer->isInitialized() && php_sapi_name() != "cli") {
			$initializer->initialize();   

		//Common run 
		} else {
       
            $util = new Util();
			require_once($util->web_root_dir . "/pat/config.php");

			if (!empty($_COOKIE["executor_password"]) && $_COOKIE["executor_password"] == $executor_password ) {
				$this->startExecutor();
			} else if (!empty($_POST['executor_password'])) {
				$password = base64_encode($_POST['executor_password']);
				if ($password == $executor_password) {
					setcookie("executor_password", $password);
					startExecutor();
				} else {
					die('Wrong password.');
				}	
			} else {
				$this->templateOutput("Введите пароль для доступа.");
			}
		}	
	}

}                       