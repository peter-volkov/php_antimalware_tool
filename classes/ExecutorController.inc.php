<?php

ob_start();
require_once("Localization.inc.php");
require_once("FileInfo.inc.php");
require_once("Healer.inc.php");
require_once("View.inc.php");
require_once("XmlValidator.inc.php");
require_once("Auth.inc.php");
ob_end_clean();

class ExecutorController {

	function startExecutor() {
		if (!empty($_POST) && !empty($_POST["recipe"])) 
		{
			$healer = new Healer();
			$xml_recipe = $_POST["recipe"];
		   
			$validator = new XmlValidator();
            global $project_root_dir;
			if (!$validator->validate($xml_recipe, $project_root_dir . "/static/xsd/recipe.xsd")) {
				die(PS_ERR_BROKEN_XML_FILE);
			}

			$view = new View();
            define('PS_EXECUTOR_RESULT', $healer->executeXmlRecipe($xml_recipe));
            define('PS_QUARANTINE_URL', $healer->getQuarantineFilename());
			$view->display("executor.tpl");

		} else {

			$view = new View();
			$view->display("executor.tpl");
		}

	}

	function start() {
		$authenticator = new Auth();

		if ($authenticator->auth()) {
			$this->startExecutor();
		}
	}

}                       