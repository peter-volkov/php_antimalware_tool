<?php
require_once ("FileInfo.inc.php");
class MalwareDetector {
    function __construct() {
        $this->SIGNATURE_FILENAME = 'signatures/malware_db.xml';
        $this->MAX_FILESIZE = 1 * 1024 * 1024; // 1MB
        $this->signatures = new DOMDocument();
        $this->signatures->load($this->SIGNATURE_FILENAME);
    }

    function detectMalware($file_path) {
        if (filesize($file_path) > $this->MAX_FILESIZE) {
           return "";
        }

        if (!is_file($file_path)) {
           return "";
        }


        $content = implode("", file($file_path));

        $db = $this->signatures->getElementsByTagName('signature');
        $detected = false;

        foreach ($db as $sig) {
           if ($detected) break;

           $sig_content = $sig->nodeValue;
           $attr = $sig->attributes;
           $attr_id = $attr->getNamedItem("id")->nodeValue;
           $attr_format = $attr->getNamedItem("format")->nodeValue;
           $attr_child_id = $attr->getNamedItem("child_id")->nodeValue;
           $attr_severity = $attr->getNamedItem("sever")->nodeValue;

           switch ($attr_format) {

              case 're': 
                         if (preg_match('#' . $sig_content . '#smi', $content, $found)) {
                            $detected = true;
                            continue;
                         }

                         break;
              case 'const': 
                         if (strpos($content, $sig_content)) {
                            $detected = true;
                            continue;
                         }

                         break;
           }
        }

        if ($detected) {
           return $attr_severity;
        }

    }

} // End of class
