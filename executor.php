<?php

ob_start();
require_once("classes/FileInfo.inc.php");
require_once("classes/Healer.inc.php");
require_once("classes/View.inc.php");
require_once("classes/XmlValidator.inc.php");
require_once("classes/Initializer.inc.php");
ob_end_clean();

function startExecutor() {
	if (!empty($_POST) && !empty($_POST["recipe"])) 
	{
		$healer = new Healer();
		$xml_recipe = $_POST["recipe"];
	   
		$validator = new XmlValidator();
		if (!$validator->validate($xml_recipe, "static/xsd/recipe.xsd")) {
			die('xml is broken');
		}
		
		$view = new View("/static/templates/");
		$view->set("title", "Result");
		$view->set("result", $healer->executeXmlRecipe($xml_recipe));
		$view->set("quarantine_url", $healer->getQuarantineFilename());
		$view->display("executor_result.tpl");

	} else {

		$view = new View("/static/templates/");
		$view->display("executor_recipe_form.tpl");
	}

}

function templateOutput($message) {
	   $view = new View("/static/templates/");
	   $view->set("message", $message);
	   $view->display("auth.tpl");
}


$initializer = new Initializer();

//First run
//Console run check for unittests
if (!$initializer->isInitialized() && php_sapi_name() != "cli") {
    $initializer->initialize();   

//Common run 
} else {

	require_once("config.php");

	if (!empty($_COOKIE["executor_password"]) && $_COOKIE["executor_password"] == $executor_password ) {
		startExecutor();
	} else if (!empty($_POST['executor_password'])) {
		$password = base64_encode($_POST['executor_password']);
		if ($password == $executor_password) {
			setcookie("executor_password", $password);
			startExecutor();
		} else {
			die('Wrong password.');
		}	
	} else {
        templateOutput("Введите пароль для доступа.");
	}
}	
