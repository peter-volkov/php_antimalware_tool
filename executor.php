<?php

require_once("classes/FileInfo.inc.php");
require_once("classes/Healer.inc.php");
require_once("classes/View.inc.php");
require_once("classes/XmlValidator.inc.php");
require_once("classes/Initializer.inc.php");

$initializer = new Initializer();

function start_executor() {
	if (!empty($_POST) && !empty($_POST["recipe"])) 
	{
		$healer = new Healer();
		$xml_recipe = $_POST["recipe"];
	   
		$validator = new XmlValidator();
		if (!$validator->validate($xml_recipe, "/static/xsd/recipe.xsd")) {
			die('xml is broken');
		}
		
		$view = new View("/static/templates/");
		$view->set("title", "Result");
		$view->set("result", $healer->execute_xml_recipe($xml_recipe));
		$view->set("quarantine_url", $healer->get_quarantine_filename());
		$view->display("executor_result.tpl");

	} else {

		$view = new View("/static/templates/");
		$view->display("executor_recipe_form.tpl");
	}

}

require_once("config.php");

if (!empty($_COOKIE["executor_password"]) && $_COOKIE["executor_password"] == $executor_password ) {
    start_executor();
} else if (!empty($_POST['executor_password'])) {
    $password = base64_encode($_POST['executor_password']);
    if ($password == $executor_password) {
        setcookie("executor_password", $password);
        start_executor();
    } else {
        die('Wrong password.');
    }	
} else {
    echo '<form action="'.$_SERVER['PHP_SELF'].'" method="POST"><input name="executor_password" type="password"></input><input type="submit"></form>';
}
