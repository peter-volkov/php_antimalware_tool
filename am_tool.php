<?

class FileInfo
{	

	public function __construct($file_path)
	{
		$this->getInfoByName($file_path);
	}
	
	public function getInfoByName($file_path)
	{
		if (file_exists($file_path))
		{
			$this->name = $file_path;
			$this->size = filesize($file_path);
			$this->lastmodified = filemtime($file_path);
			$this->crc32 = hash_file('crc32b', $file_path);
			$this->md5 = hash_file('md5', $file_path);
		} else die("no such file.");
	}
	
	public function __toString()
	{   
        $data = array($this->name, $this->size, $this->lastmodified, $this->md5);    
		return implode(';', $data);
	}

}

class FilesystemSnapshot
{
    private $files = array();

    public function getFileInfoArray() {
        return $this->files; 
    }

	function getXMLSnapshot($base_dir_name)
	{	
    
        if ($base_dir_name === '../')
            $base_dir_name = $_SERVER['DOCUMENT_ROOT'] . '/';
       
        $xml_log = new SimpleXMLElement('<website_info/>');
        $xml_log_base = $xml_log->addChild('files');

        $current_directory = end(explode('/', getcwd()));
		$excluded_dirs = array(".", "..", $current_directory);

		if (is_dir($base_dir_name)) 
		{
			if ($base_dir = opendir($base_dir_name)) 
			{
				while (($basedir_element_name = readdir($base_dir)) !== false) 
				{

				    $absolute_path = $base_dir_name . $basedir_element_name;
 
					if (is_file($absolute_path)) 
					{        
                        $fileinfo = new FileInfo($absolute_path);
                        array_push($this->files, $fileinfo);

					} else if (is_dir($absolute_path) && !in_array($basedir_element_name, $excluded_dirs)) {
                        $this->getXMLSnapshot($absolute_path."/", $logfilename);
					}

				}
				closedir($base_dir);

			} else print " dir opening error";

		} else print " no such dir";

	}

}

$fs = new FilesystemSnapshot();
$fs->getXMLSnapshot('../');
$fileInfoArray = $fs->getFileInfoArray();

$xml_log = new SimpleXMLElement('<files/>');

foreach($fileInfoArray as $fileinfo) {

    $xml_entry = $xml_log->addChild('file');
    $xml_entry->addChild('path', $fileinfo->filename);
    $xml_entry->addChild('crc32', $fileinfo->crc32);
    $xml_entry->addChild('md5', $fileinfo->md5);
    $xml_entry->addChild('size', $fileinfo->filesize);
    $xml_entry->addChild('time_modified', $fileinfo->lastmodified);
}

Header('Content-type: text/xml');		
print $xml_log->asXML();

?>


