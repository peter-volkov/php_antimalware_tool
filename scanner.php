<?php


ob_start();
require_once("classes/FileInfo.php.inc");
require_once("classes/WebServerEnvInfo.php.inc");
require_once("classes/View.php.inc");
require_once("classes/AjaxScanner.php.inc");
ob_end_clean();

$log_filename = $_SERVER['DOCUMENT_ROOT'] . dirname($_SERVER['PHP_SELF']) . '/' . 'log.xml';

$dom = new DOMDocument("1.0", "utf-8");

$website_info_node = $dom->createElement("website_info");
$dom->appendChild($website_info_node);

$ws_env = new WebServerEnvInfo();
$ws_env_node = $ws_env->getXMLNode();
$dom->documentElement->appendChild($dom->importNode($ws_env_node, true));

$files_node = $dom->createElement("files");
$dom->documentElement->appendChild($files_node);

$dom->save($log_filename);

$file_scanner = new AjaxScanner($log_filename);

//ajax request
if ( !empty($_POST['a']) )
{	
	$action = $_POST['a'];
	
	if ($action == 'prep') {
		$file_scanner->performScanning();
	} else if ($action == 'scan') {
	    $file_scanner->performScanning(); 
	} else if ($action == 'finalize') {
	    $file_scanner->performFinalize(); 
	}
}

$xml = file_get_contents($log_filename);

function template_output($xml) {
    $view = new View("/static/templates/");
    $view->set("title", "Result");
    $view->set("xml_log", htmlentities($xml));
    $view->display("scanner.tpl");
}

function raw_xml_output($xml) {
    Header("Content-type: text/xml");		
    print $xml;
}

template_output($xml);


?>


