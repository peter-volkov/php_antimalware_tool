var ajaxErrorCounter = 0;
var maxAjaxErrors = 3;

var scanForMalware = true;
var requestDelay = 3;

var numberFilesScanned = 0;
var numberFilesToScan = 0;

$(document).ready(function(){  


    $('#scanForMalwareCheckbox').change(function() {      
        scanForMalware = this.checked;
    });

    $('#requestDelayTextbox').on('change keypress paste focus textInput input', function() {              
        requestDelay = parseInt(this.value);
    });

    function finish() {
        $('#result_area').show();
        $('#spinner_gif').hide();
        $('#startButton').hide();
        $('#settingsLink').hide();
        $('#progressbar').hide();
        $('#configPanel').hide();
        $('#scannerCaption').hide();
        $('#scannerDescription').hide();
    }


    function finishGetFileList() {
        $('#spinner_gif').hide();
        if (!scanForMalware) {
            finish();
        } else {
            $('#scanForMalwareDiv').hide();
            sendRequest("index.php?controller=scanner&a=getSignatureScanResult&delay=" + requestDelay, handleSignatureScan);
            $('#progressbar').show();
        }
    }

	function handleSignatureScan(response) {

           if (response.status == 'inProcess')
           { 
               numberFilesScannedThisTime = parseInt(response.data.filesScannedThisTime)
               numberFilesLeft = parseInt(response.data.filesLeft)
               numberFilesScanned += numberFilesScannedThisTime;
               
               if (!numberFilesToScan) {
                   numberFilesToScan = numberFilesLeft + numberFilesScannedThisTime;
               }
      
               signatureScanProgress = numberFilesScanned * 100 / numberFilesToScan;
               progressBarWidth = Math.round(signatureScanProgress) + '%';
               
               $('#progressbar_inner').css('width', progressBarWidth);

               sendRequest("index.php?controller=scanner&a=getSignatureScanResult&delay=" + requestDelay, handleSignatureScan);

           } else if (response.status == 'finished') {
                              
               finish();
                              
           } else if (response.type == 'error') {

               $('#errorMessage').text(response.data);
               console.log('server ' + response.meta.type);
               console.log('server ' + response.data);

           }
                     
		console.log(response);
	}

	function handleGetFileList(response) {

           if (response.meta.status == 'inProcess')
           { 

               console.log('num_dirs=' + response.data.length);

               sendRequest("index.php?controller=scanner&a=getFileList&delay=" + requestDelay, handleGetFileList);

           } else if (response.meta.status == 'finished') {
               
               sendRequest("index.php?controller=scanner&a=getWebsiteLog&delay=" + requestDelay, function() {finishGetFileList();});
                              
           } else if (response.meta.type == 'error') {

               $('#errorMessage').text(response.data);
               console.log('server ' + response.meta.type);
               console.log('server ' + response.data);

           }
                     
		console.log(response);
	}

	function sendRequest(url, handleResponse) {        

		$.getJSON(url, function(responseJSON) {  
           handleResponse(responseJSON);
           ajaxErrorCounter = 0;           
		   
		})
		  .fail(function() {
            ajaxErrorCounter++;
			console.log("ajax error " + ajaxErrorCounter);
            if (ajaxErrorCounter < maxAjaxErrors) {
                sendRequest(url, handleResponse);
            } else {
                console.log("ajax critical error\n" + responseJSON);
            }
		})
	}
	 	
	$("#startButton").click(function() {
    	$('#spinner_gif').show();        
        $(this).attr('value', PT_STR_BUTTON_CANCEL);
		console.log("getFileList");
        sendRequest("index.php?controller=scanner&a=getFileList&delay=" + requestDelay, handleGetFileList);
        $(this).hide();
	});

    sendRequest("index.php?controller=scanner&a=cleanUp", function() {console.log('Cleanup sent')});


	$("#settingsLink").click(function() {        
	    if ($('#configPanel').is(":visible")) { 
		    $('#configPanel').hide();

        } else {
            $('#configPanel').show();
        }        
	 } 
	);

});

