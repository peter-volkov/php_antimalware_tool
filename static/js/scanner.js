var number_requests_made = 0;
var ajaxErrorCounter = 0;
var maxAjaxErrors = 3;
var scanForMalware = true;
var requestDelay = 3;

$(document).ready(function(){  


    $('#scanForMalwareCheckbox').change(function() {      
        scanForMalware = this.checked;
    });

    $('#requestDelayTextbox').on('change keypress paste focus textInput input', function() {              
        requestDelay = parseInt(this.value);
    });

    function finish() {
        $('#result_area').show();
        $('#spinner_gif').hide();
        $('#startButton').hide();
        $('#settingsLink').hide();
        $('#progressbar').hide();
        $('#scannerCaption').hide();
        $('#scannerDescription').hide();
    }

	function handleGetFileList(response) {

           if (response.meta.status == 'inProcess')
           { 

               console.log('num_dirs=' + response.data.length);

               sendRequest("index.php?controller=scanner&a=getFileList&delay=" + requestDelay, handleGetFileList);

           } else if (response.meta.status == 'finished') {

               
               sendRequest("index.php?controller=scanner&a=getWebsiteLog&delay=" + requestDelay, function() {finish();});
               
                

           } else if (response.meta.type == 'error') {

               $('#errorMessage').text(response.data);
               console.log('server ' + response.meta.type);
               console.log('server ' + response.data);

           }
                     
		console.log(response);
	}

	function sendRequest(url, handleResponse) {        

		$.getJSON(url, function(responseJSON) {  
           handleResponse(responseJSON);
           ajaxErrorCounter = 0;           
		   
		})
		  .fail(function() {
            ajaxErrorCounter++;
			console.log("ajax error " + ajaxErrorCounter);
            if (ajaxErrorCounter < maxAjaxErrors) {
                sendRequest(url, handleResponse);
            } else {
                console.log("ajax critical error");
            }
		})
	}
	 	
	$("#startButton").click(function() {
      spinner = $('#spinner_gif');
	  if (!spinner.is(":visible")) {   
		spinner.show();
        $(this).attr('value', PT_STR_BUTTON_CANCEL);
		console.log("getFileList");
        sendRequest("index.php?controller=scanner&a=getFileList&delay=" + requestDelay, handleGetFileList);
	  } else {
		spinner.hide();
        $(this).attr('value', PT_STR_SEARCH_AGAIN_BUTTON);
		console.log("canceled");
	 } 
	});

    sendRequest("index.php?controller=scanner&a=cleanUp", function() {console.log('Cleanup sent')});


	$("#settingsLink").click(function() {        
	    if ($('#configPanel').is(":visible")) { 
		    $('#configPanel').hide();

        } else {
            $('#configPanel').show();
        }        
	 } 
	);

});
