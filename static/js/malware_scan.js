
var scanForMalwareFlag = true;

$('#scan_for_malware_checkbox').change(function() {      
    scanForMalwareFlag = this.checked;
});

function finishMalwareScan() {
	scanForSignaturesFinishTime = new Date().getTime();

    $('#result_area').show();
    $('#startButton').hide();
    $('#settingsLink').hide();
    $('#progressbar').hide();

	scanForSignaturesTime = scanForSignaturesFinishTime - window.scanForSignaturesStartTime;
    console.log("Signature scan performed in " + scanForSignaturesTime + " seconds");
}


function handleMalwareScanResponse() {

    if (ajaxHttpRequest.readyState < 4)
       return; 

    // process normal page response
    if (ajaxHttpRequest.readyState == 4 && ajaxHttpRequest.status == 200) {
       var ajaxResponse = ajaxHttpRequest.responseText;

       setDebug(ajaxResponse);


       responseLines = ajaxResponse.split("\n");

       var malwareScanResponseRe = /files_scanned_this_time=(\d+)+;files_left=(\d+)/;
       var match = malwareScanResponseRe.exec(responseLines[0]);


       if (responseLines[0] == 'scan_finished') {
           finishMalwareScan();
           return;
        
       } else if (match != null) {
           if (number_files_to_scan_for_malware == 0) {
               number_files_to_scan_for_malware = parseInt(match[2]);
           }

           number_files_scanned_for_malware += parseInt(match[1]);
           malware_scan_progress = ( number_files_scanned_for_malware * 100 ) / number_files_to_scan_for_malware;
           progress_bar_width = Math.round(malware_scan_progress) + '%';
           progress_bar = document.getElementById('progressbar_inner');
           progress_bar.style.width = progress_bar_width;                     
       }

       if (window.scanForMalwareFlag) {       
           malwareScan();
       }

       // process errors
       if (responseLines[0] == 'ERR') { // "ERR"
          // finish on error came from script!

          throwError("SERVER ERROR. " + responseLines[1]);
          finishScanning(totalScanned, "ERROR OCCURED!");
         
         return;
       } // end of "ERR"


    } else {
       var error_msg = "AJAX ERROR. HTTP Status " + ajaxHttpRequest.status + " state " + ajaxHttpRequest.readyState;
       throwError(error_msg);
       finishScanning(totalScanned, "ERROR OCCURED!");
    }

}

function cancelSignatureScan() {
    window.scanForMalwareFlag = false;
    $("#spinner_gif").hide();
    $.post( 'index.php',  {'controller':'scanner', 'a':'finalize_signature_scan'}, function(data) {  console.log( data );})
    finishMalwareScan();
}


/**
 * Perform one round of file scanning for malware
 */
function malwareScan() {

  window.scanForSignaturesStartTime = new Date().getTime();

  $('#startButton').click(cancelSignatureScan);
  $('#progressbar').show();
 
  ajaxHttpRequest = createAjaxRequest();
  ajaxHttpRequest.onreadystatechange = handleMalwareScanResponse;

  var arguments = "a=malware_scan";

  ajaxHttpRequest.open("POST", file_listing_target_url, true);
  ajaxHttpRequest.setRequestHeader("Content-type","application/x-www-form-urlencoded");
  ajaxHttpRequest.send(arguments);

}


