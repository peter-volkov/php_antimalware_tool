<?php

require_once('classes/Localization.inc.php');

//////////////////////////////////////////////////////////////////////////////
// file_put_contents replacement
//////////////////////////////////////////////////////////////////////////////
function file_put_contents2($filename, $data, $die_on_err = true) {
  $f = fopen($filename, 'w');
  if (!$f) {
      if ($die_on_err) {

         $err = error_get_last();
         die(sprintf(PS_ERR_CANNOT_CREATE_FILE, $filename, $err['message']));
      }

      return false;
  } else {
      $bytes = fwrite($f, $data);
      fclose($f);
      return $bytes;
  }
}

//////////////////////////////////////////////////////////////////////////////

$project_root_dir = dirname(__FILE__);
$project_folder = basename($project_root_dir);

// check if current folder name is reliable and unique
if (strlen($project_folder) < 5) {
   die(sprintf(PS_ERR_DUMMY_FOLDER, substr(md5(time()), 0, 4), $project_folder));
}

$temp_hash = md5($project_folder . filectime('classes')); // to make it unique across server
$project_tmp_dir = sys_get_temp_dir() . DIRECTORY_SEPARATOR . $temp_hash; // e.g. mkdir('/tmp/233554340ab6521253e127354/')

if (!file_exists($project_tmp_dir)) {
   mkdir($project_tmp_dir);
   $rw_access_test_filename = $project_tmp_dir . '/rw_access';
   file_put_contents2($rw_access_test_filename, '1', false);
}

if (!is_writable($project_tmp_dir) || !file_exists($rw_access_test_filename)) {
   $project_tmp_dir = '.';
}

if (!is_writable($project_tmp_dir)) {
   die(PS_ERR_NO_TEMP_FOLDER);
}

if (empty($_REQUEST['controller']) || $_REQUEST['controller'] == 'scanner') {

	require_once('classes/ScannerController.inc.php');

	$scannerController = new ScannerController();
	$scannerController->start();

} else if ( $_REQUEST['controller'] == 'executor' ) {

	require_once('classes/ExecutorController.inc.php');

	$executorController = new ExecutorController();
	$executorController->start();

} else if ( $_REQUEST['controller'] == 'download' ) {

	require_once('classes/DownloadController.inc.php');

	$downloadController = new DownloadController();
	$downloadController->start();

}